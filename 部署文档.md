# 部署文档

## 概述
本项目为 Python 爬虫与 FastAPI 后端服务，支持在线管理站点与任务，并通过 APScheduler 进行定时执行。提供两类入口：
- `main.py`：命令行单次抓取
- `app.py`：后端服务（含任务管理与调度）

## 系统要求
- Python 3.10 及以上（容器基于 `python:3.13-slim`）
- MySQL 5.7/8.0 可用实例
- Windows/Linux/容器环境均可

依赖通过 `requirements.txt` 安装，主要包含：`fastapi`, `uvicorn`, `sqlalchemy`, `apscheduler`, `pymysql`, `requests`, `beautifulsoup4`, `bencodepy` 等。

## 目录与入口
- 后端服务入口：`app.py`
- 单次爬虫入口：`main.py` 或 `crawler.py`
- 配置文件：`config.yaml`
- 数据库管理：`db_manager.py`
- 配置读取与系统设置：`config_manager.py`
- 前端模板与静态：`templates/`, `static/`

## 依赖安装
在项目根目录执行：

Windows：
```powershell
py -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```

Linux：
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

## 配置
项目使用 `config.yaml` 管理服务端口与数据库连接等参数。示例（请替换为生产值）：
```yaml
log_level: INFO
log_file: ./logs/crawler.log
port: 8000
# MySQL 连接
db_host: <DB_HOST>
db_port: <DB_PORT>
db_user: <DB_USER>
db_password: <DB_PASSWORD>
db_name: <DB_NAME>
```
运行时的系统设置（如 `out_dir`, `torrent_download_dir`, `delay`, `test_mode`, `test_limit`, `allow_v2`, `user_agent`, `cookie`）从数据库的 `system_settings` 表读取，可通过页面或 API 管理。

SQLAlchemy 连接字符串在 `app.py` 生成（示例格式）：
```
mysql+pymysql://<DB_USER>:<DB_PASSWORD>@<DB_HOST>:<DB_PORT>/<DB_NAME>
```

## 数据库准备
- 确保 MySQL 可用，并在 `config.yaml` 中配置正确的连接信息
- 首次启动后端服务将由 `db_manager.py` 自动初始化所需表（如 `torrents`, `sites`, `tasks`, `settings`, `system_settings`）

## 启动与运行
### 启动后端服务（推荐）
在项目根目录执行：
```bash
uvicorn app:app --host 0.0.0.0 --port 8000
```
或：
```bash
python app.py
```
访问：
- 首页（模板）：`http://localhost:8000/`
- OpenAPI 文档：`http://localhost:8000/docs`

### 单次抓取（命令行）
```bash
python main.py --config config.yaml
# 或
python crawler.py --conf config.yaml
```

## 调度与任务执行
- 使用 APScheduler 后台调度器，服务启动后自动注册数据库中的任务（见 `app.py`）
- 支持两类调度：
  - `cron`：通过 crontab 表达式注册
  - `interval`：按秒级间隔执行
- 手动执行任务：`POST /tasks/{task_id}/execute`（服务会在后台创建异步任务）

## 输出与存储
- 元数据：`out_dir/metadata.jsonl`
- 详情页快照（首个）：`out_dir/first_torrent_detail_page.html`
- `.torrent` 文件：`torrent_download_dir/{info_hash}.torrent`
- 默认会确保 `out_dir/torrents/` 目录存在

## Docker 部署
构建镜像：
```bash
docker build -t pt-crawler .
```
运行容器：
```bash
docker run -p 8800:8000 pt-crawler
```
持久化输出（推荐挂载卷，并与 `config.yaml` 中路径对应）：
```bash
docker run --cap-add=NET_ADMIN -p 8800:8000 \
  -v /user/pt-crawler/data/torrents:/torrents \
  pt-crawler
```
容器默认启动命令：
```
uvicorn app:app --host 0.0.0.0 --port 8000
```

## 日志与状态查看
- 默认输出到标准输出，可用：`docker logs -f <容器ID或名称>` 实时查看
- 服务日志级别可通过 `config.yaml` 中的 `log_level` 调整（如 `INFO`、`DEBUG`）
- 镜像默认以 `uvicorn --log-level info` 启动；如需临时提升日志级别：
  - `docker run -p 8800:8000 pt-crawler uvicorn app:app --host 0.0.0.0 --port 8000 --log-level debug`
- 如需文件日志，设置 `config.yaml`：`log_file: /logs/crawler.log` 并挂载目录：
  - `docker run -p 8800:8000 -v /user/pt-crawler/logs:/logs pt-crawler`
- 在受限网络环境端口映射失败时，可使用宿主网络：
  - `docker run --network=host pt-crawler`
  - 访问地址：`http://<宿主IP>:8000`

## 生产环境建议
- 配置与密钥：将数据库密码等敏感信息通过环境或安全配置传递，避免明文提交
- 数据库权限：为服务创建最小权限账号，并启用备份与监控
- 日志与监控：当前以标准输出为主，容器中使用 `docker logs`；如需文件日志，请创建 `./logs/` 并扩展 `logging` 配置
- 调度频率：合理设置 `cron` 或 `interval`，并结合 `delay`、`user_agent`、`cookie` 进行站点友好限流
- 目录权限：确保 `out_dir` 与 `torrent_download_dir` 可写，卷挂载时检查权限

## 常见问题排查
- 服务无法启动：检查 `config.yaml` 的 MySQL 连接参数是否正确；端口冲突时修改 `port` 或 `uvicorn` 启动端口
- 抓取无输出：确认 `out_dir` 与 `torrent_download_dir` 设置正确；检查 `delay`, `user_agent`, `cookie` 是否配置合理
- 调度不执行：检查 `tasks` 表的 `schedule_type` 与表达式是否有效；查看服务启动日志是否显示任务注册；可用 `/tasks/{task_id}/execute` 进行手动验证

## 参考文件路径
- 服务与调度：`app.py`
- 爬虫逻辑与输出：`crawler.py`, `main.py`
- 配置解析与系统设置：`config_manager.py`
- 数据库管理与表结构：`db_manager.py`
- 前端模板：`templates/index.html`
