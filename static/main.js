function qs(id){return document.getElementById(id)}
function setActive(page){document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));qs('page-'+page).classList.add('active');document.querySelectorAll('#menu li').forEach(li=>{li.classList.toggle('active',li.dataset.page===page)})}
async function fetchJSON(url){const r=await fetch(url);return r.json()}
async function postJSON(url,obj){const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)});return r.json()}
function renderSites(){const el=qs('page-sites');el.innerHTML=`<div class="form-row"><input class="input" id="site_base_url" placeholder="base_url"><input class="input" id="site_list_path" placeholder="list_path"></div><div class="form-row"><input class="input" id="site_cookie" placeholder="cookie"><input class="input" id="site_user_agent" placeholder="user_agent"></div><div class="form-row"><input class="input" id="site_out_dir" placeholder="out_dir"><input class="input" id="site_tdir" placeholder="torrent_download_dir"></div><div class="form-row"><button class="btn" id="btnSiteSave">保存站点</button></div><div id="sites_msg"></div><table class="table" id="sites_table"><thead><tr><th>ID</th><th>base_url</th><th>list_path</th></tr></thead><tbody></tbody></table>`;qs('btnSiteSave').onclick=async()=>{const obj={base_url:qs('site_base_url').value,list_path:qs('site_list_path').value,cookie:qs('site_cookie').value,user_agent:qs('site_user_agent').value,out_dir:qs('site_out_dir').value,torrent_download_dir:qs('site_tdir').value};const res=await postJSON('/sites/',obj);qs('sites_msg').innerText='保存成功: '+JSON.stringify(res);loadSites()};loadSites()}
async function loadSites(){const rows=await fetchJSON('/sites');const tbody=document.querySelector('#sites_table tbody');tbody.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.base_url||''}</td><td>${r.list_path||''}</td></tr>`).join('')}
function renderTasks(){const el=qs('page-tasks');el.innerHTML=`<div class="form-row"><input class="input" id="task_name" placeholder="name"><input class="input" id="task_site_id" placeholder="site_id"></div><div class="form-row"><select class="input" id="task_type"><option value="interval">interval</option><option value="cron">cron</option></select><input class="input" id="task_value" placeholder="schedule_value"><button class="btn" id="btnTaskSave">保存任务</button></div><div id="tasks_msg"></div><table class="table" id="tasks_table"><thead><tr><th>ID</th><th>site_id</th><th>name</th><th>type</th><th>value</th></tr></thead><tbody></tbody></table>`;qs('btnTaskSave').onclick=async()=>{const obj={name:qs('task_name').value,site_id:Number(qs('task_site_id').value),schedule_type:qs('task_type').value,schedule_value:qs('task_value').value};const res=await postJSON('/tasks/',obj);qs('tasks_msg').innerText='保存成功: '+JSON.stringify(res);loadTasks()};loadTasks()}
async function loadTasks(){const rows=await fetchJSON('/tasks');const tbody=document.querySelector('#tasks_table tbody');tbody.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.site_id}</td><td>${r.name||''}</td><td>${r.schedule_type||''}</td><td>${r.schedule_value||''}</td></tr>`).join('')}
function renderTorrents(){const el=qs('page-torrents');el.innerHTML=`<div class="form-row"><input class="input" id="tor_limit" placeholder="limit" value="50"><button class="btn" id="btnTorLoad">加载</button></div><table class="table" id="tor_table"><thead><tr><th>ID</th><th>info_hash</th><th>name</th><th>size</th><th>standard</th><th>site</th><th>crawledAt</th></tr></thead><tbody></tbody></table>`;qs('btnTorLoad').onclick=loadTorrents;loadTorrents()}
async function loadTorrents(){const limit=Number(qs('tor_limit').value||50);const rows=await fetchJSON('/torrents?limit='+limit);const tbody=document.querySelector('#tor_table tbody');tbody.innerHTML=rows.map(r=>`<tr><td>${r.id}</td><td>${r.info_hash}</td><td>${r.name||''}</td><td>${r.size||''}</td><td>${r.standard||''}</td><td>${r.crawl_site||''}</td><td>${r.crawledAt||''}</td></tr>`).join('')}
function initMenu(){document.querySelectorAll('#menu li').forEach(li=>{li.onclick=()=>{setActive(li.dataset.page);if(li.dataset.page==='tasks')renderTasks();if(li.dataset.page==='sites')renderSites();if(li.dataset.page==='torrents')renderTorrents()}})}
document.addEventListener('DOMContentLoaded',function(){initMenu();setActive('tasks');renderTasks()})
